#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "support.h"

int main(int argc, char *argv[])
{
    // Get file name from args
    char *infilename;
    if (argc == 2)
    {
        infilename = argv[1];
    }
    else
    {
        printf("Usage: %s [<input_file>]\n", argv[0]);
        exit(0);
    }

    printf("Hello, and welcome to the world's GREATEST ENCRYPTION SYSTEM\n");

    // Open file and get length
    FILE *infile = fopen(infilename, "r");
    fseek(infile, 0, SEEK_END);
    int flen = ftell(infile);
    fseek(infile, 0, 0);

    // Retrieve key seed
    char keyseedc[2 * KEY_LEN + 1];
    FILE *keyseedf;
    if (!(keyseedf = fopen("./keyseed", "r")))
    {
        printf("Error: Couldn't open keyseed\n");
        exit(8);
    }
    fgets(keyseedc, 2 * KEY_LEN + 1, keyseedf);
    unsigned int keyseedx;
    sscanf(keyseedc, "%x", &keyseedx);
    fclose(keyseedf);

    // Calculate number of chunks to encrypt and padding amount
    unsigned int chunks = (flen + KEY_LEN - 1) / KEY_LEN;
    unsigned int pad = (KEY_LEN - flen % KEY_LEN) % KEY_LEN;

    // Create and load encryption buffer
    char buffer[flen + pad + 1];
    fread(buffer, 1, flen, infile);
    fclose(infile);
    for (int i = 0; i <= pad; i++)
    {
        buffer[flen + i] = '\0';
    }

    // Pointer to beginning of buffer
    unsigned int *ptr = &buffer[0]; // throws warning because of weird casting

    // Super secret encryption algorithm
    encrypt(ptr, keyseedx, chunks);

    // Write encrypted data out
    FILE *overwrite = fopen(infilename, "w");
    fwrite(buffer, 1, sizeof(buffer) - 1, overwrite);
    fclose(overwrite);

    return 0;
}